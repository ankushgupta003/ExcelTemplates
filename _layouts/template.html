<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | {{ site.title }}</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      crossorigin="anonymous"
    />
  </head>
  <body>
    {% include header.html %}

    <div class="container py-5">
      <div class="row g-4">
        <!-- Left column: Images -->
        <div class="col-md-6">
          <!-- Desktop / Tablet: Normal layout -->
          <div class="d-none d-md-block">
            <img
              src="{{ page.image }}"
              alt="{{ page.title }}"
              class="img-fluid mb-3 rounded shadow-sm"
              data-bs-toggle="modal"
              data-bs-target="#imageModal"
            />

            {% if page.gallery %}
            <div class="row g-3">
              {% for item in page.gallery %}
              <div class="col-6">
                <img
                  src="{{ item.image }}"
                  alt="Template Screenshot"
                  class="img-fluid rounded shadow-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#imageModal"
                />
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Mobile: Horizontal scroll -->
          <div class="d-md-none">
            <div class="d-flex overflow-auto gap-2 pb-2">
              <div class="flex-shrink-0" style="width: 250px">
                <img
                  src="{{ page.image }}"
                  alt="{{ page.title }}"
                  class="img-fluid rounded shadow-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#imageModal"
                />
              </div>

              {% if page.gallery %} {% for item in page.gallery %}
              <div class="flex-shrink-0" style="width: 250px">
                <img
                  src="{{ item.image }}"
                  alt="Template Screenshot"
                  class="img-fluid rounded shadow-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#imageModal"
                />
              </div>
              {% endfor %} {% endif %}
            </div>
          </div>
        </div>

        <!-- Bootstrap Modal (Full screen vertical scroll) -->
        <div class="modal fade" id="imageModal" tabindex="-1">
          <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
              <div class="modal-header border-0">
                <button
                  type="button"
                  class="btn-close btn-close-white"
                  data-bs-dismiss="modal"
                ></button>
              </div>
              <div
                class="modal-body d-flex flex-column align-items-center gap-3 overflow-auto"
              >
                <!-- Main image -->
                <img
                  src="{{ page.image }}"
                  class="img-fluid rounded shadow-sm"
                  alt="{{ page.title }}"
                />

                <!-- Gallery images -->
                {% if page.gallery %} {% for item in page.gallery %}
                <img
                  src="{{ item.image }}"
                  class="img-fluid rounded shadow-sm"
                  alt="Template Screenshot"
                />
                {% endfor %} {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Right column: Content -->
        <div class="col-md-6">
          <h1 class="mb-3">{{ page.title }}</h1>
          <div class="lead">{{ page.description | markdownify }}</div>
          <h3 class="mt-4 text-success">â‚¹{{ page.price }}</h3>

          <!-- Razorpay Buy Now -->
          <button
            id="rzp-button"
            class="btn btn-primary btn-lg rounded-pill px-5 fw-bold shadow-lg"
            data-bs-toggle="modal"
            data-bs-target="#emailModal"
          >
            Buy Now
          </button>
          <div>
            <h4 class="mt-4">Features</h4>
            {{ page.features | markdownify }}
          </div>

          <div>
            <h4 class="mt-4">How it works</h4>
            {{ page.how_it_works | markdownify }}
          </div>
        </div>
      </div>
    </div>

    <!-- YouTube Video -->
    <div class="container my-5">
      <h2 class="mb-3">Watch Demo</h2>
      <div
        class="embed-responsive embed-responsive-16by9 rounded-4 shadow-lg"
        style="--bs-aspect-ratio: 56.25%"
      >
        <iframe
          class="w-100"
          src="https://www.youtube.com/embed/{{ page.video | split: '/' | last }}"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        ></iframe>
      </div>
    </div>

    <!-- You May Also Like -->
    <div class="container py-5">
      <h2 class="text-center fw-bold mb-5 text-primary">More from Templates</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for template in site.templates %} {% unless template.url == page.url
        %}
        <div class="col">
          <div
            class="card bg-dark-card border-0 rounded-4 shadow-lg p-3 template-card"
          >
            <img
              src="{{ template.image | relative_url }}"
              class="card-img-top rounded-3"
              alt="{{ template.title }} Template"
            />
            <div class="card-body">
              <h5 class="card-title fw-bold text-light">
                {{ template.title }}
              </h5>
              <p class="card-text">
                {{ template.description | strip_html | truncate: 150 }}
              </p>
              <a
                href="{{ site.baseurl }}{{ template.url }}"
                class="btn btn-outline-secondary rounded-pill px-4 mt-2"
                >View Details</a
              >
            </div>
          </div>
        </div>
        {% endunless %} {% endfor %}
      </div>
    </div>

    <!-- Email Modal (Razorpay Checkout) -->
    <div class="modal fade" id="emailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
          <div class="modal-header">
            <h5 class="modal-title">Enter your Email</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="emailForm">
              <input
                type="email"
                id="customerEmailInput"
                class="form-control"
                placeholder="your@email.com"
                required
              />
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="submit"
              form="emailForm"
              class="btn btn-purchase w-100"
              id="paymentBtn"
            >
              <span id="paymentBtnText">Continue to Payment</span>
              <span
                id="paymentBtnSpinner"
                class="spinner-border spinner-border-sm d-none"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Razorpay Logic (same as your original, trimmed here for brevity) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      document.getElementById('emailForm').onsubmit = function(e) {
          e.preventDefault(); // Prevent form submission

          const customerEmail = document.getElementById('customerEmailInput').value;
          const paymentBtn = document.getElementById('paymentBtn');
          const paymentBtnText = document.getElementById('paymentBtnText');
          const paymentBtnSpinner = document.getElementById('paymentBtnSpinner');

          // Disable button and show spinner
          paymentBtn.disabled = true;
          paymentBtnText.classList.add('d-none');
          paymentBtnSpinner.classList.remove('d-none');

          // Hide the modal after getting the email
          const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
          emailModal.hide();

          // Updated backend URL for Netlify Function
          const backendUrl = "/.netlify/functions/create-razorpay-order";
          // Get the price from the Jekyll variable and convert it to paisa
          const price = {{ page.price }} * 100;
          const name = "{{ page.title }}";
          const downloadLink = "{{ page.download_link }}"; // Get the download link from Jekyll

          // Log the payload to the console before sending
          console.log("Sending payload to backend:", { amount: price, product_name: name });

          fetch(backendUrl, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  amount: price,
                  product_name: name
              }),
          })
          .then(response => {
              if (!response.ok) {
                  // Log the response text if the request was not successful
                  return response.text().then(text => {
                      console.error("Backend Error:", text);
                      throw new Error("HTTP error " + response.status + ": " + text);
                  });
              }
              return response.json();
          })
          .then(order => {
              if (order.id) {
                  const options = {
                      "key": "rzp_test_RA2NakVSYF1k5z", // Replace with your actual Razorpay Key ID
                      "amount": order.amount,
                      "currency": "INR", // Change to USD or other currency if needed
                      "name": "The Sheet Vault",
                      "description": name,
                      "order_id": order.id,
                      "handler": function (response) {
                          // This is where you would call another backend endpoint to verify the payment
                          const verifyUrl = "/.netlify/functions/verify-payment";

                          fetch(verifyUrl, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  razorpay_order_id: response.razorpay_order_id,
                                  razorpay_payment_id: response.razorpay_payment_id,
                                  razorpay_signature: response.razorpay_signature,
                                  product_name: name,
                                  download_link: downloadLink, // Send the download link to the backend
                                  customer_email: customerEmail // Send the customer's email to the backend
                              }),
                          })
                          .then(res => res.json())
                          .then(data => {
                              if (data.success) {
                                  // Use a custom message box instead of alert()
                                  // since alerts are blocked by the iframe
                                  console.log("Payment verified. A link to your template has been sent to your email!");
                              } else {
                                  console.error("Payment verification failed. Please contact support.");
                              }
                          });
                      },
                      "prefill": {
                          "name": "Your Name",
                          "email": customerEmail // Now using the email from the modal
                      },
                      "oncancel": function() {
                          // Explicitly hide the modal and backdrop
                          const emailModalElement = document.getElementById('emailModal');
                          const emailModal = bootstrap.Modal.getInstance(emailModalElement);
                          if (emailModal) {
                              emailModal.hide();
                          }
                          const backdrop = document.querySelector('.modal-backdrop');
                          if (backdrop) {
                              backdrop.remove();
                          }
                      }
                  };
                  const rzp1 = new Razorpay(options);
                  rzp1.open();
              } else {
                  console.error("Failed to create order. Please try again later.");
              }
          })
          .catch(error => {
              console.error('An error occurred:', error);
          })
          .finally(() => {
              // Re-enable button and hide spinner regardless of outcome
              paymentBtn.disabled = false;
              paymentBtnText.classList.remove('d-none');
              paymentBtnSpinner.classList.add('d-none');
          });
      };

      // Initialize the modal if Bootstrap is available
      window.onload = function() {
          // This is a workaround to make the button work with the modal
          const rzpButton = document.getElementById('rzp-button');
          rzpButton.onclick = function() {
              const myModal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
              if (myModal) {
                  myModal.show();
              } else {
                  const newModal = new bootstrap.Modal(document.getElementById('emailModal'));
                  newModal.show();
              }
          };
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
