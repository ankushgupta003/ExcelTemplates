<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | {{ site.title }}</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css" />
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2H+9gBf/Hj9iH7q9G9/r3c5yN95c5w/s5L1g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body class="bg-dark text-light">
    {% include header.html %}

    <div class="container py-5">
      <div class="row align-items-center">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <img
            src="{{ page.image | relative_url }}"
            class="img-fluid rounded-4 shadow-lg template-card-img"
            alt="{{ page.title }}"
          />
        </div>
        <div class="col-lg-6">
          <h1 class="display-5 fw-bold text-primary">{{ page.title }}</h1>
          <p class="lead mt-4">{{ page.description }}</p>
          <div class="mt-4">
            <h5 class="fw-bold text-light">Key Features:</h5>
            <ul class="list-unstyled mt-3">
              {% for feature in page.features %}
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i> {{ feature
                }}
              </li>
              {% endfor %}
            </ul>
          </div>
          <div class="mt-5">
            <button
              id="rzp-button"
              class="btn btn-primary btn-lg rounded-pill px-5 fw-bold shadow-lg"
            >
              Purchase Now - Rs.{{ page.price }}
            </button>
            <a
              href="{{ site.baseurl }}/#contact"
              class="btn btn-outline-secondary btn-lg rounded-pill px-5 fw-bold ms-3"
              >Ask a Question</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- More Features Section -->
    <section class="container py-5 text-center">
      <h2 class="fw-bold mb-5 text-primary">More Features</h2>

      <!-- Carousel container -->
      <div
        id="screenshotsCarousel"
        class="carousel slide"
        data-bs-ride="carousel"
        data-bs-interval="9999999999"
      >
        <!-- Carousel inner and items -->
        <div class="carousel-inner">
          {% for screenshot in page.screenshots %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row g-4 justify-content-center align-items-center">
              <div class="col-lg-8">
                <img
                  src="{{ screenshot.url | relative_url }}"
                  class="d-block w-100 rounded-4 shadow-lg"
                  style="aspect-ratio: 16/9"
                  alt="Template Screenshot {{ forloop.index }}"
                />
              </div>
              <div class="col-lg-4">
                <div
                  class="card bg-dark-card border-0 rounded-4 shadow-lg h-100 p-4"
                >
                  <div class="card-body">
                    <p class="card-text">{{ screenshot.description }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Carousel controls (next and previous buttons) placed below -->
      {% if page.screenshots.size > 1 %}
      <div class="d-flex justify-content-center mt-4">
        <button
          class="btn btn-secondary mx-2 rounded-pill"
          type="button"
          data-bs-target="#screenshotsCarousel"
          data-bs-slide="prev"
        >
          <i class="fas fa-arrow-left"></i>
          <span class="visually-hidden">Previous</span>
        </button>
        <button
          class="btn btn-secondary mx-2 rounded-pill"
          type="button"
          data-bs-target="#screenshotsCarousel"
          data-bs-slide="next"
        >
          <i class="fas fa-arrow-right"></i>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      {% endif %} {% if page.video %}
      <div class="row justify-content-center mt-5">
        <div class="col-md-8 col-lg-6">
          <h3 class="fw-bold text-light mb-3">Watch the Tutorial</h3>
          <div
            class="embed-responsive embed-responsive-16by9 rounded-4 shadow-lg"
            style="--bs-aspect-ratio: 56.25%"
          >
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/{{ page.video | split: '/' | last }}"
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            ></iframe>
          </div>
        </div>
      </div>
      {% endif %}
    </section>

    <hr />

    <!-- More from Templates Section -->
    <div class="container py-5">
      <h2 class="text-center fw-bold mb-5 text-primary">More from Templates</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for template in site.templates %} {% unless template.url == page.url
        %}
        <div class="col">
          <div
            class="card bg-dark-card border-0 rounded-4 shadow-lg p-3 template-card"
          >
            <img
              src="{{ template.image | relative_url }}"
              class="card-img-top rounded-3"
              alt="{{ template.title }} Template"
            />
            <div class="card-body">
              <h5 class="card-title fw-bold text-light">
                {{ template.title }}
              </h5>
              <p class="card-text">
                {{ template.description | strip_html | truncate: 150 }}
              </p>
              <a
                href="{{ site.baseurl }}{{ template.url }}"
                class="btn btn-outline-secondary rounded-pill px-4 mt-2"
                >View Details</a
              >
            </div>
          </div>
        </div>
        {% endunless %} {% endfor %}
      </div>
    </div>

    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      document.getElementById('rzp-button').onclick = function(e) {
          // Updated backend URL for Netlify Function
          const backendUrl = "/.netlify/functions/create-razorpay-order";
          // Get the price from the Jekyll variable and convert it to paisa
          const price = {{ page.price }} * 100;
          const name = "{{ page.title }}";

          // Log the payload to the console before sending
          console.log("Sending payload to backend:", { amount: price, product_name: name });

          fetch(backendUrl, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  amount: price,
                  product_name: name
              }),
          })
          .then(response => {
              if (!response.ok) {
                  // Log the response text if the request was not successful
                  return response.text().then(text => {
                      console.error("Backend Error:", text);
                      throw new Error("HTTP error " + response.status + ": " + text);
                  });
              }
              return response.json();
          })
          .then(order => {
              if (order.id) {
                  const options = {
                      "key": "rzp_test_RA1jsPMnUvgjSe", // Replace with your actual Razorpay Key ID
                      "amount": order.amount,
                      "currency": "INR", // Change to USD or other currency if needed
                      "name": "The Sheet Vault",
                      "description": name,
                      "order_id": order.id,
                      "handler": function (response) {
                          // This is where you would call another backend endpoint to verify the payment and send the sheet URL
                          const verifyUrl = "/.netlify/functions/verify-payment";
                          fetch(verifyUrl, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  razorpay_order_id: response.razorpay_order_id,
                                  razorpay_payment_id: response.razorpay_payment_id,
                                  razorpay_signature: response.razorpay_signature,
                                  product_name: name
                              }),
                          })
                          .then(res => res.json())
                          .then(data => {
                              if (data.success) {
                                  // Payment verified. Show a success message or redirect.
                                  alert("Payment verified. A link to your template has been sent to your email!");
                              } else {
                                  alert("Payment verification failed. Please contact support.");
                              }
                          });
                      },
                      "prefill": {
                          "name": "Your Name", // Customer Name
                          "email": "customer@example.com" // Customer Email
                      }
                  };
                  const rzp1 = new Razorpay(options);
                  rzp1.open();
              } else {
                  alert("Failed to create order. Please try again later.");
              }
          })
          .catch(error => {
              console.error('An error occurred:', error);
              alert("An error occurred. Please check the console for details.");
          });

          e.preventDefault();
      };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      xintegrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
