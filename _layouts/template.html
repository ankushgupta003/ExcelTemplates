<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page.title }} | {{ site.title }}</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css" />
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2H+9gBf/Hj9iH7q9G9/r3c5yN95c5w/s5L1g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Glassmorphism styling for the modal */
      .modal-content {
        background-color: rgba(31, 36, 44, 0.5) !important;
        border: 1px solid rgba(22, 27, 34, 0.7) !important;
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25) !important;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .modal-header, .modal-footer {
        border-color: rgba(22, 27, 34, 0.7) !important;
      }
      .modal-title, .modal-body {
        color: #e5e7eb;
      }
      .form-control {
        border: 1px solid rgba(22, 27, 34, 0.7) !important;
        border-radius: 0.5rem;
      }
      .form-control:focus {
       
        border-color: #d232c1 !important;
        box-shadow: 0 0 0 0.25rem rgba(210, 50, 193, 0.25);
      }
      .btn-primary {
        background-color: #460980 !important;
        border-color: #460980 !important;
        box-shadow: 0 0 10px rgba(210, 50, 193, 0.4) !important;
      }
      .btn-outline-secondary {
        border-color: #8b949e !important;
        color: #8b949e !important;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    {% include header.html %}

    <div class="container py-5">
      <div class="row align-items-center">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <img
            src="{{ page.image | relative_url }}"
            class="img-fluid rounded-4 shadow-lg template-card-img"
            alt="{{ page.title }}"
          />
        </div>
        <div class="col-lg-6">
          <h1 class="display-5 fw-bold text-primary">{{ page.title }}</h1>
          <p class="lead mt-4">{{ page.description }}</p>
          <div class="mt-4">
            <h5 class="fw-bold text-light">Key Features:</h5>
            <ul class="list-unstyled mt-3">
              {% for feature in page.features %}
              <li>
                <i class="fas fa-check-circle text-primary me-2"></i> {{ feature
                }}
              </li>
              {% endfor %}
            </ul>
          </div>
          <div class="mt-5">
            <button
              id="rzp-button"
              class="btn btn-primary btn-lg rounded-pill px-5 fw-bold shadow-lg"
              data-bs-toggle="modal"
              data-bs-target="#emailModal"
            >
              Purchase Now - Rs.{{ page.price }}
            </button>
            <a
              href="{{ site.baseurl }}/#contact"
              class="btn btn-outline-secondary btn-lg rounded-pill px-5 fw-bold ms-3"
              >Ask a Question</a
            >
          </div>
        </div>
      </div>
    </div>

    <!-- More Features Section -->
    <section class="container py-5 text-center">
      <h2 class="fw-bold mb-5 text-primary">More Features</h2>

      <!-- Carousel container -->
      <div
        id="screenshotsCarousel"
        class="carousel slide"
        data-bs-ride="carousel"
        data-bs-interval="9999999999"
      >
        <!-- Carousel inner and items -->
        <div class="carousel-inner">
          {% for screenshot in page.screenshots %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <div class="row g-4 justify-content-center align-items-center">
              <div class="col-lg-8">
                <img
                  src="{{ screenshot.url | relative_url }}"
                  class="d-block w-100 rounded-4 shadow-lg"
                  style="aspect-ratio: 16/9"
                  alt="Template Screenshot {{ forloop.index }}"
                />
              </div>
              <div class="col-lg-4">
                <div
                  class="card bg-dark-card border-0 rounded-4 shadow-lg h-100 p-4"
                >
                  <div class="card-body">
                    <p class="card-text">{{ screenshot.description }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Carousel controls (next and previous buttons) placed below -->
      {% if page.screenshots.size > 1 %}
      <div class="d-flex justify-content-center mt-4">
        <button
          class="btn btn-secondary mx-2 rounded-pill"
          type="button"
          data-bs-target="#screenshotsCarousel"
          data-bs-slide="prev"
        >
          <i class="fas fa-arrow-left"></i>
          <span class="visually-hidden">Previous</span>
        </button>
        <button
          class="btn btn-secondary mx-2 rounded-pill"
          type="button"
          data-bs-target="#screenshotsCarousel"
          data-bs-slide="next"
        >
          <i class="fas fa-arrow-right"></i>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      {% endif %} {% if page.video %}
      <div class="row justify-content-center mt-5">
        <div class="col-md-8 col-lg-6">
          <h3 class="fw-bold text-light mb-3">Watch the Tutorial</h3>
          <div
            class="embed-responsive embed-responsive-16by9 rounded-4 shadow-lg"
            style="--bs-aspect-ratio: 56.25%"
          >
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/{{ page.video | split: '/' | last }}"
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"
              allowfullscreen
            ></iframe>
          </div>
        </div>
      </div>
      {% endif %}
    </section>

    <hr />

    <!-- More from Templates Section -->
    <div class="container py-5">
      <h2 class="text-center fw-bold mb-5 text-primary">More from Templates</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for template in site.templates %} {% unless template.url == page.url
        %}
        <div class="col">
          <div
            class="card bg-dark-card border-0 rounded-4 shadow-lg p-3 template-card"
          >
            <img
              src="{{ template.image | relative_url }}"
              class="card-img-top rounded-3"
              alt="{{ template.title }} Template"
            />
            <div class="card-body">
              <h5 class="card-title fw-bold text-light">
                {{ template.title }}
              </h5>
              <p class="card-text">
                {{ template.description | strip_html | truncate: 150 }}
              </p>
              <a
                href="{{ site.baseurl }}{{ template.url }}"
                class="btn btn-outline-secondary rounded-pill px-4 mt-2"
                >View Details</a
              >
            </div>
          </div>
        </div>
        {% endunless %} {% endfor %}
      </div>
    </div>

    <!-- Email Input Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Enter your Email</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="emailForm">
                        <div class="mb-3">
                            <label for="customerEmailInput" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="customerEmailInput" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="emailForm" class="btn btn-primary" id="paymentBtn">
                        <span id="paymentBtnText">Continue to Payment</span>
                        <span id="paymentBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        document.getElementById('emailForm').onsubmit = function(e) {
            e.preventDefault(); // Prevent form submission
            
            const customerEmail = document.getElementById('customerEmailInput').value;
            const paymentBtn = document.getElementById('paymentBtn');
            const paymentBtnText = document.getElementById('paymentBtnText');
            const paymentBtnSpinner = document.getElementById('paymentBtnSpinner');

            // Disable button and show spinner
            paymentBtn.disabled = true;
            paymentBtnText.classList.add('d-none');
            paymentBtnSpinner.classList.remove('d-none');

            // Hide the modal after getting the email
            const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
            emailModal.hide();

            // Updated backend URL for Netlify Function
            const backendUrl = "/.netlify/functions/create-razorpay-order";
            // Get the price from the Jekyll variable and convert it to paisa
            const price = {{ page.price }} * 100;
            const name = "{{ page.title }}";
            const downloadLink = "{{ page.download_link }}"; // Get the download link from Jekyll

            // Log the payload to the console before sending
            console.log("Sending payload to backend:", { amount: price, product_name: name });

            fetch(backendUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: price,
                    product_name: name
                }),
            })
            .then(response => {
                if (!response.ok) {
                    // Log the response text if the request was not successful
                    return response.text().then(text => {
                        console.error("Backend Error:", text);
                        throw new Error("HTTP error " + response.status + ": " + text);
                    });
                }
                return response.json();
            })
            .then(order => {
                if (order.id) {
                    const options = {
                        "key": "rzp_test_RA2NakVSYF1k5z", // Replace with your actual Razorpay Key ID
                        "amount": order.amount,
                        "currency": "INR", // Change to USD or other currency if needed
                        "name": "The Sheet Vault",
                        "description": name,
                        "order_id": order.id,
                        "handler": function (response) {
                            // This is where you would call another backend endpoint to verify the payment
                            const verifyUrl = "/.netlify/functions/verify-payment";
                            
                            fetch(verifyUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_signature: response.razorpay_signature,
                                    product_name: name,
                                    download_link: downloadLink, // Send the download link to the backend
                                    customer_email: customerEmail // Send the customer's email to the backend
                                }),
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    // Use a custom message box instead of alert()
                                    // since alerts are blocked by the iframe
                                    console.log("Payment verified. A link to your template has been sent to your email!");
                                } else {
                                    console.error("Payment verification failed. Please contact support.");
                                }
                            });
                        },
                        "prefill": {
                            "name": "Your Name", 
                            "email": customerEmail // Now using the email from the modal
                        },
                        "oncancel": function() {
                            // Explicitly hide the modal and backdrop
                            const emailModalElement = document.getElementById('emailModal');
                            const emailModal = bootstrap.Modal.getInstance(emailModalElement);
                            if (emailModal) {
                                emailModal.hide();
                            }
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) {
                                backdrop.remove();
                            }
                        }
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.open();
                } else {
                    console.error("Failed to create order. Please try again later.");
                }
            })
            .catch(error => {
                console.error('An error occurred:', error);
            })
            .finally(() => {
                // Re-enable button and hide spinner regardless of outcome
                paymentBtn.disabled = false;
                paymentBtnText.classList.remove('d-none');
                paymentBtnSpinner.classList.add('d-none');
            });
        };

        // Initialize the modal if Bootstrap is available
        window.onload = function() {
            // This is a workaround to make the button work with the modal
            const rzpButton = document.getElementById('rzp-button');
            rzpButton.onclick = function() {
                const myModal = new bootstrap.Modal(document.getElementById('emailModal'));
                myModal.show();
            };
        };
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      xintegrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
